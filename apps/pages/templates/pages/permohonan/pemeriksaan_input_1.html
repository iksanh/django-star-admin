{% extends "layouts/base.html" %}
{% load static %}
{% load split_points %}
{% load custom_tags %}

{% block title %} Verifikasi Berkas - {{ pemohon.nama_pemohon }} {% endblock title %}

{% block extra_css %}
<style>
    /* --- 1. SIDEBAR NAVIGASI (Sticky & Modern) --- */
    .sidebar-sticky {
        position: -webkit-sticky;
        position: sticky;
        top: 20px; /* Jarak dari atas saat scroll */
        max-height: calc(100vh - 100px);
        overflow-y: auto;
        padding-right: 5px;
    }
    
    /* Scrollbar cantik untuk sidebar */
    .sidebar-sticky::-webkit-scrollbar { width: 5px; }
    .sidebar-sticky::-webkit-scrollbar-thumb { background: #ddd; border-radius: 10px; }

    .nav-pills .nav-link {
        color: #555;
        background-color: #fff;
        border: 1px solid #eef0f3;
        margin-bottom: 8px;
        padding: 12px 15px;
        border-radius: 10px;
        font-size: 0.9rem;
        line-height: 1.4;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        
        /* Agar teks panjang turun ke bawah (Wrap) */
        white-space: normal; 
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }

    .nav-pills .nav-link:hover {
        background-color: #f8f9fa;
        border-color: #4B49AC;
        transform: translateY(-1px);
    }

    /* State Active: Ungu StarAdmin */
    .nav-pills .nav-link.active {
        background-color: #4B49AC;
        color: white;
        border-color: #4B49AC;
        box-shadow: 0 4px 12px rgba(75, 73, 172, 0.3);
    }
    .nav-pills .nav-link.active i { color: white !important; }
    .nav-pills .nav-link.active .badge { background-color: rgba(255,255,255,0.2) !important; color: white !important; }

    /* --- 2. CHECKLIST AREA (Clickable Box) --- */
    .checklist-item {
        background-color: #fff;
        border: 1px solid #e8e8e8;
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        transition: all 0.2s;
        cursor: pointer;
        display: flex;
        align-items: flex-start;
    }
    
    .checklist-item:hover {
        background-color: #f0f3ff;
        border-color: #b1bdfa;
    }

    /* Input Checkbox Custom */
    .form-check-input {
        width: 1.3em;
        height: 1.3em;
        margin-top: 0.1em;
        margin-right: 12px;
        cursor: pointer;
        border: 2px solid #ccc;
    }
    .form-check-input:checked {
        background-color: #4B49AC;
        border-color: #4B49AC;
    }
    
    .form-check-label {
        cursor: pointer;
        width: 100%;
        font-weight: 500;
        color: #333;
        padding-top: 2px;
    }

    /* --- 3. GUIDE BOX (Kanan) --- */
    .guide-box {
        background-color: #f8f9fa;
        border-left: 4px solid #4B49AC;
        height: 100%;
    }
    .guide-list li {
        margin-bottom: 12px;
        line-height: 1.5;
        color: #555;
    }

    /* --- 4. FLOATING SAVE BAR --- */
    .save-bar {
        position: fixed;
        bottom: 0;
        right: 0;
        left: 260px; /* Sesuaikan dengan lebar sidebar menu utama */
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(5px);
        border-top: 1px solid #ddd;
        padding: 15px 30px;
        z-index: 1030;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        transition: left 0.3s;
    }
    
    @media (max-width: 991px) {
        .save-bar { left: 0; } /* Mobile Full Width */
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="main-panel">
    <div class="content-wrapper" style="padding-bottom: 120px;"> <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-body p-4 d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div>
                            <h3 class="fw-bold mb-1 text-dark">Verifikasi Berkas</h3>
                            <div class="text-muted d-flex align-items-center">
                                <i class="ti-user me-1 text-primary"></i> <span class="fw-bold me-3">{{ pemohon.nama_pemohon }}</span>
                                <i class="ti-folder me-1 text-primary"></i> <span>{{ pemohon.layanan.nama }}</span>
                            </div>
                        </div>
                        <div>
                            <span class="badge badge-primary fs-6 px-3 py-2 rounded-pill">
                                <i class="ti-check-box me-2"></i>
                                Progress: {{ pemeriksaan_map|length }} / {{ daftar_berkas|length }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <form method="POST" id="form-pemeriksaan">
            {% csrf_token %}

            <div class="row">
                
                <div class="col-lg-3 col-md-4 d-none d-md-block">
                    <div class="sidebar-sticky">
                        <h6 class="text-uppercase text-muted fw-bold small px-2 mb-3 ls-1">Daftar Berkas</h6>
                        
                        <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                            {% for item in daftar_berkas %}
                            {% with pemeriksaan=pemeriksaan_map|get_item:item.id %}
                            
                            <button class="nav-link text-start {% if forloop.first %}active{% endif %}"
                                    id="tab-{{ item.id }}"
                                    data-bs-toggle="pill"
                                    data-bs-target="#content-{{ item.id }}"
                                    type="button"
                                    role="tab">
                                
                                <div class="d-flex align-items-center w-100">
                                    <span class="badge bg-light text-dark me-2 border" style="min-width: 24px;">{{ forloop.counter }}</span>
                                    <span class="flex-grow-1">{{ item.nama }}</span>
                                    
                                    {% if pemeriksaan %}
                                        {% if pemeriksaan.status == 'OK' or pemeriksaan.catatan.count == 0 and not pemeriksaan.catatan_baru %}
                                            <i class="ti-check text-success ms-2 fw-bold"></i>
                                        {% else %}
                                            <i class="ti-info-alt text-warning ms-2"></i>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </button>

                            {% endwith %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="col-lg-9 col-md-8 col-12">
                    <div class="card shadow-sm border-0" style="min-height: 500px;">
                        <div class="card-body p-4">
                            
                            <div class="tab-content" id="v-pills-tabContent">
                                {% for item in daftar_berkas %}
                                {% with pemeriksaan=pemeriksaan_map|get_item:item.id %}
                                
                                <div class="tab-pane fade {% if forloop.first %}show active{% endif %}"
                                     id="content-{{ item.id }}"
                                     role="tabpanel"
                                     aria-labelledby="tab-{{ item.id }}">

                                    <div class="d-flex justify-content-between align-items-center border-bottom pb-3 mb-4">
                                        <div>
                                            <h4 class="fw-bold text-dark mb-1">{{ item.nama }}</h4>
                                            <p class="text-muted small mb-0">Silakan periksa kelengkapan fisik dan validitas data.</p>
                                        </div>
                                        <span class="badge bg-light text-secondary border">Urutan: {{ forloop.counter }}</span>
                                    </div>

                                    <div class="row">
                                        <div class="col-lg-7 pe-lg-4 mb-4 mb-lg-0">
                                            
                                            <h6 class="fw-bold text-primary mb-3">
                                                <i class="ti-check-box me-1"></i> Poin Pemeriksaan
                                            </h6>

                                            <div class="checklist-wrapper mb-4">
                                                {% for t in item.templates.all %}
                                                <div class="checklist-item" onclick="document.getElementById('chk_{{ item.id }}_{{ t.id }}').click()">
                                                    <input class="form-check-input" 
                                                           type="checkbox" 
                                                           name="catatan_{{ item.id }}" 
                                                           value="{{ t.id }}" 
                                                           id="chk_{{ item.id }}_{{ t.id }}"
                                                           onclick="event.stopPropagation()"
                                                           {% if pemeriksaan and t in pemeriksaan.catatan.all %}checked{% endif %}>
                                                    <label class="form-check-label user-select-none" for="chk_{{ item.id }}_{{ t.id }}">
                                                        {{ t.teks }}
                                                    </label>
                                                </div>
                                                {% empty %}
                                                <div class="alert alert-light text-center small text-muted border border-dashed py-3">
                                                    Tidak ada template pemeriksaan standar.
                                                </div>
                                                {% endfor %}
                                                
                                                <div id="dynamic-checklist-container-{{ item.id }}"></div>
                                            </div>

                                            <div class="mt-4">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <label class="fw-bold small text-dark mb-0">Catatan Khusus / Temuan Lain</label>
                                                    <button type="button" class="btn btn-sm btn-link text-decoration-none fw-bold"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#modalAddNote"
                                                            data-berkasid="{{ item.id }}"
                                                            data-berkasname="{{ item.nama }}">
                                                        <i class="ti-plus"></i> Tambah Template Cepat
                                                    </button>
                                                </div>
                                                <textarea class="form-control bg-light"
                                                          name="catatan_baru_{{ item.id }}"
                                                          rows="4"
                                                          style="border: 1px solid #eee;"
                                                          placeholder="Tulis catatan manual di sini jika diperlukan...">{{ pemeriksaan.catatan_baru|default_if_none:"" }}</textarea>
                                                
                                                <div id="extra_notes_holder_{{ item.id }}"></div>
                                            </div>

                                        </div>

                                        <div class="col-lg-5">
                                            <div class="guide-box p-3 rounded-3">
                                                <h6 class="fw-bold mb-3 text-dark d-flex align-items-center">
                                                    <i class="ti-book me-2 text-primary"></i> Panduan Verifikasi
                                                </h6>
                                                
                                                {% if item.catatan %}
                                                    <ul class="list-unstyled guide-list small mb-0">
                                                    {% for point in item.catatan|split_points %}
                                                        <li class="d-flex align-items-start">
                                                            <i class="ti-angle-right text-primary me-2 mt-1 flex-shrink-0"></i>
                                                            <span>{{ point }}</span>
                                                        </li>
                                                    {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <div class="text-center py-5 text-muted opacity-75">
                                                        <i class="ti-agenda fs-2 mb-2 d-block"></i>
                                                        <span class="small">Tidak ada panduan khusus.</span>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-flex justify-content-between mt-5 pt-4 border-top">
                                        {% if not forloop.first %}
                                            <button type="button" class="btn btn-outline-secondary btn-icon-text" onclick="switchTab('prev')">
                                                <i class="ti-arrow-left btn-icon-prepend"></i> Sebelumnya
                                            </button>
                                        {% else %}
                                            <div></div>
                                        {% endif %}

                                        {% if not forloop.last %}
                                            <button type="button" class="btn btn-primary btn-icon-text px-4" onclick="switchTab('next')">
                                                Selanjutnya <i class="ti-arrow-right btn-icon-append"></i>
                                            </button>
                                        {% endif %}
                                    </div>

                                </div> 
                                {% endwith %}
                                {% endfor %}
                            </div>

                        </div>
                    </div>
                </div>

            </div> <div class="save-bar d-flex justify-content-between align-items-center">
                <div class="d-none d-md-block">
                    <small class="text-muted"><i class="ti-info-alt me-1"></i> Pastikan semua berkas telah diverifikasi sebelum menyimpan.</small>
                </div>
                <div class="d-flex gap-2 w-100 w-md-auto justify-content-end">
                    <a href="javascript:history.back()" class="btn btn-light btn-lg border">Batal</a>
                    <button class="btn btn-success btn-lg text-white px-5 shadow fw-bold" type="submit">
                        <i class="ti-save me-2"></i> SIMPAN HASIL
                    </button>
                </div>
            </div>

        </form>
    </div>
</div>

<div class="modal fade" id="modalAddNote" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Tambah Catatan Cepat</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formAddNote" onsubmit="return handleAddNote(event);">
                <div class="modal-body p-4">
                    <input type="hidden" id="modalBerkasId">
                    <p class="text-muted small mb-3">Menambahkan catatan untuk: <strong id="modalBerkasName" class="text-dark"></strong></p>
                    
                    <div class="form-group mb-0">
                        <label class="form-label fw-bold">Isi Catatan</label>
                        <input type="text" id="modalNoteText" class="form-control form-control-lg" placeholder="Contoh: Tanggal surat tidak sesuai..." required autofocus>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary px-4">Tambahkan</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock content %}

{% block extra_js %}
<script>
    // --- 1. LOGIC PINDAH TAB (Next/Prev) ---
    function switchTab(direction) {
        const activeTabEl = document.querySelector('#v-pills-tab .nav-link.active');
        const allTabs = Array.from(document.querySelectorAll('#v-pills-tab .nav-link'));
        const currentIndex = allTabs.indexOf(activeTabEl);
        let nextIndex = -1;

        if (direction === 'next' && currentIndex < allTabs.length - 1) {
            nextIndex = currentIndex + 1;
        } else if (direction === 'prev' && currentIndex > 0) {
            nextIndex = currentIndex - 1;
        }

        if (nextIndex !== -1) {
            const nextTabTrigger = allTabs[nextIndex];
            const tabInstance = new bootstrap.Tab(nextTabTrigger);
            tabInstance.show();
            // Auto scroll sidebar ke tab yang aktif
            nextTabTrigger.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Scroll main window ke atas sedikit agar enak dilihat
            window.scrollTo({ top: 100, behavior: 'smooth' });
        }
    }

    // --- 2. MODAL LOGIC (Client Side Only - Cepat & Aman) ---
    // Saat modal dibuka, isi data hidden field
    const modalAddNote = document.getElementById('modalAddNote');
    modalAddNote.addEventListener('show.bs.modal', function (e) {
        const button = e.relatedTarget;
        document.getElementById('modalBerkasId').value = button.getAttribute('data-berkasid');
        document.getElementById('modalBerkasName').textContent = button.getAttribute('data-berkasname');
        document.getElementById('modalNoteText').value = '';
        setTimeout(() => document.getElementById('modalNoteText').focus(), 500);
    });

    // Handle Submit Modal
    function handleAddNote(e) {
        e.preventDefault();
        
        const berkasId = document.getElementById('modalBerkasId').value;
        const noteText = document.getElementById('modalNoteText').value.trim();
        
        if (!noteText) return;

        // Buat ID unik sementara
        const tempId = 'extra_' + Date.now();

        // 1. Buat Elemen Visual (Checklist Baru)
        const container = document.getElementById(`dynamic-checklist-container-${berkasId}`);
        const newItem = document.createElement('div');
        newItem.className = 'checklist-item animate__animated animate__fadeIn'; // Efek animasi jika ada library
        newItem.style.backgroundColor = '#e8f0fe'; // Highlight warna beda dikit
        newItem.onclick = function() { document.getElementById(`chk_${tempId}`).click(); };
        
        newItem.innerHTML = `
            <input class="form-check-input" type="checkbox" checked disabled>
            <label class="form-check-label fw-bold text-primary w-100" style="cursor:pointer">
                ${noteText} <span class="badge bg-primary ms-2" style="font-size:0.6em">BARU</span>
            </label>
        `;
        container.appendChild(newItem);

        // 2. Buat Hidden Input untuk dikirim ke Server
        // Kita masukkan ke dalam array 'catatan_extra_{berkas_id}'
        const hiddenHolder = document.getElementById(`extra_notes_holder_${berkasId}`);
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = `catatan_extra_${berkasId}`; // Pastikan di views.py menangkap 'catatan_extra_ID'
        hiddenInput.value = noteText;
        hiddenHolder.appendChild(hiddenInput);

        // Tutup Modal
        const modalInstance = bootstrap.Modal.getInstance(modalAddNote);
        modalInstance.hide();
    }
</script>
{% endblock extra_js %}