{% extends "layouts/base.html" %}
{% load static %}
{% load split_points %}
{% load custom_tags %}

{% block title %} Pemeriksaan Berkas {% endblock title %}

{% block content %}
<div class="main-panel">
    <div class="content-wrapper">
        <div class="row">
            <div class="col-sm-12">
                <div class="card">
                <div class="card-body">
                  <h4 class="card-title">Solid header accordion</h4>
                  <p class="card-description">Use class <code>.accordion-solid-header</code> for basic accordion</p>
                {% for item in daftar_berkas %}
                        {% with pemeriksaan=pemeriksaan_map|get_item:item.id %}

              
                  <div class="mt-4">
                    <div class="accordion accordion-solid-header" id="accordion-{{ item.id }}" role="tablist">
                      <div class="card">
                        <div class="card-header" role="tab" id="heading-{{ item.id }}">
                          <h6 class="mb-0">
                            <a data-bs-toggle="collapse" href="#collapse-{{ item.id }}" aria-expanded="false" aria-controls="collapse-{{ item.id }}" class="collapsed">
                              {{ item.nama }}
                            </a>
                          </h6>
                        </div>
                        <div id="collapse-{{ item.id }}" class="collapse" role="tabpanel" aria-labelledby="heading-{{ item.id }}" data-bs-parent="#accordion-4" style="">
                          <div class="card-body">
                            <div class="row">
                              <div class="col-3">
                                <img src="../../../assets/images/samples/300x300/10.jpg" class="mw-100" alt="image">
                              </div>
                              <div class="col-9">
                                <p class="mb-0">You can pay for the product you have purchased using credit cards, debit
                                  cards, or via online banking.
                                  We also on-delivery services.</p>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                    </div>
                  </div>
               
 {% endwith %}
 {% endfor %}
  </div>
              </div>
              <div class="card">
                    <div class="card-body">
                        <div class="card-title">
                <div class="container py-3">

                    <h3 class="mb-3">Pemeriksaan Berkas</h3>

                    <div class="mb-4">
                        <span class="fw-bold">Pemohon:</span> {{ pemohon.nama_pemohon }}
                    </div>

                    <form method="POST" id="form-pemeriksaan">
                        {% csrf_token %}

                        {% for item in daftar_berkas %}
                        {% with pemeriksaan=pemeriksaan_map|get_item:item.id %}

                        <div class="accordion accordion-solid-header" id="accordion-{{ item.id }}" role="tablist">
                      <div class="card">
                        <div class="card-header" role="tab" id="heading-{{ item.id }}">
                          <h6 class="mb-0">
                            <a data-bs-toggle="collapse" href="#collapse-{{ item.id }}" aria-expanded="false" aria-controls="collapse-{{ item.id }}" class="">
                              {{ item.nama }}
                            </a>
                          </h6>
                        </div>
                        <div id="collapse-{{ item.id }}" class="collapse show" role="tabpanel" aria-labelledby="heading-{{ item.id }}" data-bs-parent="#accordion-{{ item.id }}" style="">
                          <div class="card-body">
                            <div class="row">
                              <div class="col-3">
                                <img src="../../../assets/images/samples/300x300/10.jpg" class="mw-100" alt="image">
                              </div>
                              <div class="col-9">
                                <p class="mb-0">You can pay for the product you have purchased using credit cards, debit
                                  cards, or via online banking.
                                  We also on-delivery services.</p>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                     
                    </div>
                      

                        {% endwith %}
                        {% endfor %}

                        <div class="mt-4 d-flex justify-content-end">
                            <button class="btn btn-success btn-lg px-4" type="submit">
                                Simpan Pemeriksaan
                            </button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
        <!-- MODAL ADD NOTE -->
        <div class="modal fade" id="modalAddNote" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">

                    <form id="formAddNote" onsubmit="return handleAddNote(event);">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">Tambah Catatan Baru untuk <span id="modalBerkasName"></span></h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body">
                            <input type="hidden" id="modalBerkasId">

                            <label class="form-label">Isi Catatan</label>
                            <input type="text" id="modalNoteText" class="form-control" required>

                        </div>

                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                            <button class="btn btn-primary" type="submit">Tambah Catatan</button>
                        </div>

                    </form>

                </div>
            </div>
        </div>

    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
// Ambil csrf dari cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let c of cookies) {
            const cookie = c.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');


// Modal auto-fill
let modalAddNote = document.getElementById('modalAddNote');
modalAddNote.addEventListener('show.bs.modal', function (e) {
    let button = e.relatedTarget;
    document.getElementById('modalBerkasId').value = button.getAttribute('data-berkasid');
    document.getElementById('modalBerkasName').innerHTML = button.getAttribute('data-berkasname');
    document.getElementById('modalNoteText').value = '';
    
});


// Handler modal tambah catatan
async function handleAddNote(e) {
    e.preventDefault();

    const berkasId = document.getElementById('modalBerkasId').value;
    const teks = document.getElementById('modalNoteText').value.trim();
    

    if (!teks) return false;

    const checklistContainer = document.querySelector(`#accordion-${berkasId} .checklist-container`);
    const extraHolder = document.getElementById(`extra_notes_holder_${berkasId}`);

    const makeGlobal = true;

    if (makeGlobal) {
        const resp = await fetch("{% url 'ajax_create_catatan' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({ berkas_id: berkasId, teks: teks })
        });

        const data = await resp.json();

        const checkbox = document.createElement('div');
        checkbox.className = 'form-check form-check-inline';
        checkbox.innerHTML = `
            <input class="form-check-input" type="checkbox"
                   name="catatan_${berkasId}" value="${data.id}"
                   id="ct_${berkasId}_${data.id}" checked>
            <label class="form-check-label" for="ct_${berkasId}_${data.id}">${data.teks}</label>
        `;

        checklistContainer.appendChild(checkbox);

    } else {
        const safeKey = 'x' + Date.now();
        const checkbox = document.createElement('div');
        checkbox.className = 'form-check form-check-inline';
        checkbox.innerHTML = `
            <input class="form-check-input" type="checkbox"
                   name="catatan_${berkasId}" value="extra__${safeKey}"
                   id="ct_${berkasId}_${safeKey}" checked>
            <label class="form-check-label" for="ct_${berkasId}_${safeKey}">${teks}</label>
        `;
        checklistContainer.appendChild(checkbox);

        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = `catatan_extra_${berkasId}`;
        hidden.value = teks;
        extraHolder.appendChild(hidden);
    }

    bootstrap.Modal.getInstance(modalAddNote).hide();
}
</script>
{% endblock extra_js %}
