{% extends "layouts/base.html" %}
{% load static %}
{% load custom_tags %}

{% block title %} Pemeriksaan Berkas {% endblock title %}

{% block content %}
<div class="container py-3">
    <h3 class="mb-3">Pemeriksaan Berkas</h3>
    <div class="mb-4">
        <span class="fw-bold">Pemohon:</span> {{ pemohon.nama_pemohon }}
    </div>

    <form method="POST" id="form-pemeriksaan">
        {% csrf_token %}

        {% for item in daftar_berkas %}
        {% with pemeriksaan=pemeriksaan_map|get_item:item.id %}
        <div class="card shadow-sm mb-4" id="card-{{ item.id }}">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">{{ item.nama }}</h6>

                <button type="button" class="btn btn-sm btn-light"
                        data-bs-toggle="modal"
                        data-bs-target="#modalAddNote"
                        data-berkasid="{{ item.id }}"
                        data-berkasname="{{ item.nama }}">
                    + Catatan
                </button>
            </div>

            <div class="card-body">
                <p class="text-black fw-bold small mb-1">Pilih catatan:</p>

                <div class="d-flex flex-wrap gap-3 checklist-container ps-4">
                    {% for t in item.templates.all %}
                    <div class="form-check form-check-inline">
                        <input class="form-check-input"
                               type="checkbox"
                               name="catatan_{{ item.id }}"
                               value="{{ t.id }}"
                               id="ct_{{ item.id }}_{{ t.id }}"
                               {% if pemeriksaan and t in pemeriksaan.catatan.all %}checked{% endif %}>
                        <label class="form-check-label" for="ct_{{ item.id }}_{{ t.id }}">
                            {{ t.teks }}
                        </label>
                    </div>
                    {% empty %}
                    <span class="text-muted">Belum ada template catatan</span>
                    {% endfor %}
                </div>

                <hr class="my-3">

                <label class="form-label small text-black fw-bold">Catatan khusus untuk permohonan ini:</label>
                <textarea class="form-control form-control-lg"
          name="catatan_baru_{{ item.id }}"
          placeholder="Tambahkan catatan tambahan di sini..."
          style="min-height: 120px; resize: vertical;">{% if pemeriksaan %}{{ pemeriksaan.catatan_baru }}{% endif %}</textarea>


                <!-- tempat hidden input dari modal -->
                <div id="extra_notes_holder_{{ item.id }}"></div>

            </div>
        </div>
        {% endwith %}
        {% endfor %}

        <div class="mt-4 d-flex justify-content-end">
            <button class="btn btn-success btn-lg px-4" type="submit">
                Simpan Pemeriksaan
            </button>
        </div>
    </form>
</div>

<!-- Modal Add Note -->
<div class="modal fade" id="modalAddNote" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="formAddNote" onsubmit="return handleAddNote(event);">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Tambah Catatan Baru untuk <span id="modalBerkasName"></span></h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <input type="hidden" id="modalBerkasId">

          <label class="form-label">Isi Catatan</label>
          <input type="text" id="modalNoteText" class="form-control" required>

          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="modalMakeGlobal">
            <label class="form-check-label" for="modalMakeGlobal">
              Jadikan catatan global (disimpan di template)
            </label>
          </div>

        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button class="btn btn-primary" type="submit">Tambah Catatan</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
// Ambil csrf dari cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let c of cookies) {
            const cookie = c.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

let modalAddNote = document.getElementById('modalAddNote');
modalAddNote.addEventListener('show.bs.modal', function (e) {
    let button = e.relatedTarget;
    document.getElementById('modalBerkasId').value = button.getAttribute('data-berkasid');
    document.getElementById('modalBerkasName').innerHTML = button.getAttribute('data-berkasname');
    document.getElementById('modalNoteText').value = '';
    document.getElementById('modalMakeGlobal').checked = false;
});

// Handler modal tambah catatan
async function handleAddNote(e) {
    e.preventDefault();
    const berkasId = document.getElementById('modalBerkasId').value;
    const teks = document.getElementById('modalNoteText').value.trim();
    const makeGlobal = document.getElementById('modalMakeGlobal').checked;

    if (!teks) return false;

    const checklistContainer = document.querySelector(`#card-${berkasId} .checklist-container`);
    const extraHolder = document.getElementById(`extra_notes_holder_${berkasId}`);

    if (makeGlobal) {
        const resp = await fetch("{% url 'ajax_create_catatan' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({ berkas_id: berkasId, teks: teks })
        });

        const data = await resp.json();
        const checkbox = document.createElement('div');
        checkbox.className = 'form-check form-check-inline';
        checkbox.innerHTML = `
            <input class="form-check-input" type="checkbox"
                   name="catatan_${berkasId}" value="${data.id}"
                   id="ct_${berkasId}_${data.id}" checked>
            <label class="form-check-label" for="ct_${berkasId}_${data.id}">${data.teks}</label>
        `;
        checklistContainer.appendChild(checkbox);

    } else {
        const safeKey = 'x' + Date.now();
        const checkbox = document.createElement('div');
        checkbox.className = 'form-check form-check-inline';
        checkbox.innerHTML = `
            <input class="form-check-input" type="checkbox"
                   name="catatan_${berkasId}" value="extra__${safeKey}"
                   id="ct_${berkasId}_${safeKey}" checked>
            <label class="form-check-label" for="ct_${berkasId}_${safeKey}">${teks}</label>
        `;
        checklistContainer.appendChild(checkbox);

        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = `catatan_extra_${berkasId}`;
        hidden.value = teks;
        extraHolder.appendChild(hidden);
    }

    bootstrap.Modal.getInstance(modalAddNote).hide();
    return false;
}


</script>
{% endblock extra_js %}
